<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="manifest" href="/seed-collection/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Seed Collection Field Data (Google Sheets Sync)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load jsPDF and html2canvas for client-side PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Mobile-first styling */
        :root {
            --primary-blue: #1d4ed8;
            --secondary-green: #059669;
            --danger-red: #dc2626;
            --text-color: #1f2937;
            --background-color: #f3f4f6;
            --card-background: #ffffff;
            --border-color: #d1d5db;
            --success-color: #065f46;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 480px;
            margin: auto;
        }

        .card {
            background-color: var(--card-background);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        input, select, button {
            transition: all 0.2s;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .primary-btn {
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            /* Default button styles are set in JS using Tailwind classes */
        }
        
        .primary-btn:hover:not(:disabled) {
            filter: brightness(110%);
        }
        
        /* Specific style for offline/disabled sync button */
        .sync-btn-offline {
            background-color: var(--danger-red) !important;
            color: white;
            opacity: 0.8;
            cursor: not-allowed;
        }

        /* Status colors */
        .status-online {
            background-color: #d1fae5;
            color: var(--success-color);
            border: 1px solid #a7f3d0;
        }
        .status-offline {
            background-color: #fee2e2;
            color: var(--danger-red);
            border: 1px solid #fecaca;
        }
        .status-syncing {
            background-color: #fffbeb;
            color: #b45309;
            border: 1px solid #fde68a;
        }
        .status-success {
            background-color: #d1fae5;
            color: var(--success-color);
            border: 1px solid #a7f3d0;
        }
        .error-message {
            color: var(--danger-red);
            font-size: 0.875rem;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
        }
        .sync-icon {
            animation: spin 1.5s linear infinite;
        }
        .loader {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary-blue); 
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for PDF generation content */
        .pdf-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #000;
        }
        .pdf-record {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6">Seed Collection Field Data</h1>

        <!-- Status & User Info -->
        <div class="card p-3 flex justify-between items-center mb-4">
            <div id="status-indicator" class="px-3 py-1 text-sm font-medium rounded-full status-offline">
                Offline (Sync Required)
            </div>
            <!-- Unique ID for Local Storage (since we don't have Firebase UID) -->
            <div class="text-xs text-gray-500 truncate" title="Unique device ID for local storage">
                Device ID: <span id="user-id">Loading...</span>
            </div>
        </div>
        
      


        <!-- Data Entry Form -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">New Seed Collection Record</h2>
            <form id="data-form" class="space-y-3">
                
                <!-- Date Taken (Automatic) -->
                <div>
                    <label for="date-collected" class="block text-sm font-medium text-gray-700">Date Collected</label>
                    <input type="date" id="date-collected" class="input-field" readonly required>
                </div>

                <!-- Range Dropdown -->
                <div>
                    <label for="input-range" class="block text-sm font-medium text-gray-700">Range</label>
                    <select id="input-range" class="input-field" required>
                        <option value="" disabled selected>Select Range</option>
                        <option value="Range_A">Range A</option>
                        <option value="Range_B">Range B</option>
                        <option value="Range_C">Range C</option>
                        <option value="Range_D">Range D</option>
                    </select>
                </div>
                
                <!-- Village Input -->
                <div>
                    <label for="input-village" class="block text-sm font-medium text-gray-700">Village</label>
                    <input type="text" id="input-village" placeholder="Enter Village Name" class="input-field" required>
                </div>
                
                <!-- Species Dropdown -->
                <div>
                    <label for="input-species" class="block text-sm font-medium text-gray-700">Species</label>
                    <select id="input-species" class="input-field" required>
                        <option value="" disabled selected>Select Species</option>
                        <option value="Albizia_lebbeck">Albizia lebbeck</option>
                        <option value="Azadirachta_indica">Azadirachta indica</option>
                        <option value="Tectona_grandis">Tectona grandis</option>
                        <option value="Dalbergia_sissoo">Dalbergia sissoo</option>
                    </select>
                </div>
                
                <!-- Amount of Seed Collected in kg -->
                <div>
                    <label for="input-seed-kg" class="block text-sm font-medium text-gray-700">Amount of Seed Collected (kg)</label>
                    <input type="number" step="0.01" min="0" id="input-seed-kg" placeholder="e.g., 5.75" class="input-field" required>
                </div>
                
                <!-- CPT No. -->
                <div>
                    <label for="input-cpt" class="block text-sm font-medium text-gray-700">CPT No.</label>
                    <input type="text" id="input-cpt" placeholder="Enter CPT Number" class="input-field" required>
                </div>

                <!-- GPS Location Button/Display -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">GPS Location</label>
                    <button type="button" id="get-gps-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 w-full mb-2 flex items-center justify-center">
                        <span id="gps-btn-text">Get Current GPS Location</span>
                        <div id="gps-loader" class="loader ml-3 hidden"></div>
                    </button>
                    <input type="text" id="input-gps" placeholder="Lat: -, Lon: -" class="input-field text-center font-mono bg-gray-50" readonly required>
                    <p id="gps-error" class="error-message hidden"></p>
                </div>

                <button type="submit" id="save-btn" class="primary-btn bg-green-600 hover:bg-green-700 w-full mt-4">Save Record Locally</button>
            </form>
        </div>

        <!-- Data Sync and List -->
        <div class="card mt-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Submitted Records</h2>
            
            <!-- NEW: Download and Sync Buttons -->
            <div class="flex space-x-2 mb-4"> 
                <button id="download-button" class="primary-btn flex-1 flex items-center justify-center bg-gray-600 hover:bg-gray-700 disabled:bg-gray-400">
                    <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    Download Data
                </button>
                <button id="sync-button" class="primary-btn flex-1 flex items-center justify-center bg-blue-600 hover:bg-blue-700">
                    <svg id="sync-icon-svg" class="h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0012 4a8.001 8.001 0 00-7.01 10.957M20 20v-5h-.581m0 0a8.003 8.003 0 01-15.357-2l-.001-.002m0 0a8.003 8.003 0 0115.357 2l.001.002z"/>
                    </svg>
                    Sync 0 Records
                </button>
            </div>
            
            <div id="data-list" class="space-y-3">
                <p class="text-center text-gray-500" id="loading-message">Loading local records...</p>
            </div>
        </div>
        
        <!-- Custom Modal for Alerts/Confirmation -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                <h3 id="modal-title" class="text-lg font-bold mb-2 text-gray-800"></h3>
                <p id="modal-message" class="mb-4 text-gray-600"></p>
                <div id="modal-actions" class="flex justify-end space-x-3">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>
        
        <!-- Container for PDF Content (Always hidden on the screen) -->
        <div id="pdf-content-wrapper" class="absolute -top-[9999px] w-[1000px] bg-white p-10">
            <!-- Content for PDF rendering is dynamically injected here -->
        </div>
    </div>

    <script>
        // --- Configuration ---
        // !!! IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL !!!
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyXItUzNFSlFnMqB8bE06_0XhyKOR3Aa6EeECoyoHN_UVd1xDL-oTYKd42TPaxbTqoIng/exec"; 
        const STORAGE_KEY = 'seedCollectionData_v2';
        const PENDING_SYNC_KEY = 'pendingSyncData_v2';
        const DEVICE_ID_KEY = 'deviceId';
        
        // --- DOM References ---
        const form = document.getElementById('data-form');
        const dataList = document.getElementById('data-list');
        const statusIndicator = document.getElementById('status-indicator');
        const userIdSpan = document.getElementById('user-id');
        const loadingMessage = document.getElementById('loading-message');
        const dateInput = document.getElementById('date-collected');
        const gpsInput = document.getElementById('input-gps');
        const getGpsBtn = document.getElementById('get-gps-btn');
        const gpsError = document.getElementById('gps-error');
        const syncButton = document.getElementById('sync-button');
        const downloadButton = document.getElementById('download-button'); 
        const syncIconSvg = document.getElementById('sync-icon-svg');
        const saveButton = document.getElementById('save-btn');
        const gpsBtnText = document.getElementById('gps-btn-text');
        const gpsLoader = document.getElementById('gps-loader');
        const pdfContentWrapper = document.getElementById('pdf-content-wrapper'); 

        let deviceId = localStorage.getItem(DEVICE_ID_KEY);
        if (!deviceId) {
            deviceId = `device-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            localStorage.setItem(DEVICE_ID_KEY, deviceId);
        }
        userIdSpan.textContent = deviceId;
        
        let isSyncDoneModalOpen = false;

        // --- Utility Functions ---

        /**
         * Shows a custom modal dialog for alerts or confirmations.
         */
        function showModal(title, message, actions = [{label: 'Close', className: 'primary-btn', onClick: () => closeModal()}]) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const modalActions = document.getElementById('modal-actions');
            modalActions.innerHTML = ''; // Clear previous buttons
            
            actions.forEach(action => {
                const button = document.createElement('button');
                // Use Tailwind classes for consistent styling
                const baseClass = 'px-4 py-2 rounded-lg font-medium';
                let btnClass = baseClass;
                
                if (action.className === 'primary-btn') {
                    btnClass += ' bg-blue-600 text-white hover:bg-blue-700';
                } else if (action.className === 'bg-gray-200 text-gray-700 hover:bg-gray-300') {
                    btnClass += ' bg-gray-200 text-gray-700 hover:bg-gray-300';
                } else if (action.className.includes('bg-red-')) {
                    btnClass += ' bg-red-600 text-white hover:bg-red-700';
                } else if (action.className.includes('status-syncing')) {
                    btnClass += ' bg-yellow-100 text-yellow-800 cursor-default';
                } else if (action.className.includes('status-success')) {
                    btnClass += ' bg-green-600 text-white hover:bg-green-700';
                }

                button.textContent = action.label;
                button.className = btnClass;
                button.onclick = () => {
                    action.onClick();
                    // Do not auto-close if action explicitly requests it to stay open (e.g., for loading)
                    if (action.autoClose !== false) {
                        closeModal(); 
                    }
                };
                modalActions.appendChild(button);
            });

            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal').classList.add('flex');
        }

        /**
         * Closes the modal and triggers a refresh if it was the sync done modal.
         */
        function closeModal() {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('custom-modal').classList.remove('flex');

            if (isSyncDoneModalOpen) {
                isSyncDoneModalOpen = false;
                renderData(); // Refresh the list
                updateStatusIndicator(); // Update the sync button counter
            }
        }

        /**
         * Sets the automatic date to today.
         */
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
        }

        /**
         * Handles getting the current GPS location with better offline robustness.
         */
        function getGpsLocation() {
            gpsInput.value = 'Attempting to fetch...';
            getGpsBtn.disabled = true;
            gpsBtnText.textContent = 'Fetching Location...';
            gpsLoader.classList.remove('hidden');
            gpsError.classList.add('hidden');
            
            if (navigator.geolocation) {
                const options = { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        const accuracy = position.coords.accuracy.toFixed(1);
                        
                        gpsInput.value = `Lat: ${lat}, Lon: ${lon} (±${accuracy}m)`;
                        
                        getGpsBtn.disabled = false;
                        gpsBtnText.textContent = 'Get Current GPS Location';
                        gpsLoader.classList.add('hidden');
                        showModal("Location Found", `GPS fix achieved with accuracy: ±${accuracy} meters.`, [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
                    },
                    (error) => {
                        console.error("GPS Error:", error);
                        
                        let errorMessage = 'Could not retrieve GPS location.';
                        if (error.code === 1) {
                            errorMessage = 'Permission denied. Please allow location access for this application.';
                        } else if (error.code === 2) {
                            errorMessage = 'Position unavailable. Try moving to a spot with a clearer sky view.';
                        } else if (error.code === 3) {
                            errorMessage = 'Timeout reached. Could not get a satellite lock within 30 seconds.';
                        }

                        gpsInput.value = 'GPS Unavailable';
                        gpsError.textContent = `Error: ${errorMessage}`;
                        gpsError.classList.remove('hidden');
                        
                        getGpsBtn.disabled = false;
                        gpsBtnText.textContent = 'Get Current GPS Location';
                        gpsLoader.classList.add('hidden');
                        showModal("Location Error", errorMessage, [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
                    },
                    options
                );
            } else {
                gpsInput.value = 'Geolocation not supported';
                gpsError.textContent = 'Geolocation is not supported by this browser.';
                gpsError.classList.remove('hidden');
                
                getGpsBtn.disabled = false;
                gpsBtnText.textContent = 'Get Current GPS Location';
                gpsLoader.classList.add('hidden');
            }
        }

        /**
         * Toggles the network status indicator and sync button state.
         */
        function updateStatusIndicator(isSyncing = false) {
            const pendingCount = getPendingRecords().length;
            const isOnline = navigator.onLine;

            // 1. Handle Syncing State
            if (isSyncing) {
                statusIndicator.textContent = 'Syncing...';
                statusIndicator.className = 'px-3 py-1 text-sm font-medium rounded-full status-syncing';
                syncIconSvg.classList.add('sync-icon');
                syncButton.textContent = `Syncing ${pendingCount} Records...`;
                syncButton.disabled = true;
                downloadButton.disabled = true; 
                syncButton.classList.remove('sync-btn-offline', 'bg-blue-600', 'hover:bg-blue-700', 'bg-gray-400', 'cursor-not-allowed');
                syncButton.classList.add('bg-yellow-500', 'opacity-80', 'cursor-wait');
                return;
            }
            
            // 2. Handle Non-Syncing States
            syncIconSvg.classList.remove('sync-icon');
            syncButton.classList.remove('sync-btn-offline', 'bg-blue-600', 'hover:bg-blue-700', 'bg-gray-400', 'cursor-not-allowed', 'opacity-80', 'cursor-wait', 'bg-yellow-500');
            syncButton.classList.add('primary-btn');

            if (pendingCount > 0) {
                downloadButton.disabled = false;
                
                if (isOnline) {
                    // Online & Pending: Active Sync Button (Blue)
                    statusIndicator.textContent = `Online (${pendingCount} pending)`;
                    statusIndicator.className = 'px-3 py-1 text-sm font-medium rounded-full status-online';
                    syncButton.textContent = `Sync ${pendingCount} Records`;
                    syncButton.disabled = false;
                    syncButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    // Offline & Pending: Disabled Sync Button (Red)
                    statusIndicator.textContent = `Offline (${pendingCount} pending)`;
                    statusIndicator.className = 'px-3 py-1 text-sm font-medium rounded-full status-offline';
                    syncButton.textContent = `Offline - Sync ${pendingCount} Records`;
                    syncButton.disabled = true;
                    syncButton.classList.add('sync-btn-offline'); 
                }
            } else {
                // No Pending Records
                downloadButton.disabled = true;

                if (isOnline) {
                    // Online & Synced: Disabled (Gray)
                    statusIndicator.textContent = 'Online (Synced)';
                    statusIndicator.className = 'px-3 py-1 text-sm font-medium rounded-full status-online';
                    syncButton.textContent = `All Records Synced`;
                    syncButton.disabled = true;
                    syncButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    // Offline & Synced: Disabled (Red/Gray for Offline)
                    statusIndicator.textContent = 'Offline (Synced)';
                    statusIndicator.className = 'px-3 py-1 text-sm font-medium rounded-full status-offline';
                    syncButton.textContent = `Offline - No Records to Sync`;
                    syncButton.disabled = true;
                    syncButton.classList.add('sync-btn-offline');
                }
            }
        }

        // --- Local Storage Functions ---

        function getLocalRecords() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Error reading from local storage:", e);
                return [];
            }
        }

        function saveLocalRecords(records) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
                localStorage.setItem(PENDING_SYNC_KEY, JSON.stringify(records));
                renderData();
                updateStatusIndicator();
            } catch (e) {
                console.error("Error writing to local storage:", e);
                showModal("Local Storage Error", "Failed to save data locally. Your browser storage might be full or corrupted.", [{label: 'OK', className: 'bg-red-600 text-white hover:bg-red-700', onClick: closeModal}]);
            }
        }
        
        function getPendingRecords() {
            return getLocalRecords();
        }
        
        function savePendingRecords(records) {
            saveLocalRecords(records);
        }

        function addLocalRecord(record) {
            const records = getLocalRecords();
            
            const tempId = `local-${Date.now()}`;
            const newRecord = { 
                ...record, 
                id: tempId, 
                deviceId: deviceId, 
                isSynced: false 
            };

            records.unshift(newRecord); 
            
            saveLocalRecords(records); 
        }
        
        function markRecordsAsSynced(syncedRecordIds) {
            // Clears all pending records from local storage
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem(PENDING_SYNC_KEY);
        }

        // --- UI Rendering ---

        function renderData() {
            const records = getLocalRecords(); 
            dataList.innerHTML = '';
            loadingMessage.classList.add('hidden');

            if (records.length === 0) {
                dataList.innerHTML = '<p class="text-center text-gray-500">No pending records found. All data is synced or deleted.</p>';
                return;
            }

            records.sort((a, b) => {
                const timeA = a.id.includes('local') ? parseInt(a.id.split('-')[1]) : 0;
                const timeB = b.id.includes('local') ? parseInt(b.id.split('-')[1]) : 0;
                return timeB - timeA;
            });


            records.forEach(record => {
                const docId = record.id;
                const syncBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2 py-0.5 rounded-full">PENDING SYNC</span>`;

                const listItem = document.createElement('div');
                listItem.className = `p-4 border border-gray-200 rounded-lg shadow-sm transition-all bg-red-50 hover:bg-red-100 border-red-300`;
                
                listItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-xs text-gray-500">Record ID: ${docId}</p>
                        ${syncBadge}
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <p><strong>Date:</strong> ${record.dateCollected || 'N/A'}</p>
                        <p><strong>Range:</strong> ${record.range || 'N/A'}</p>
                        <p><strong>Village:</strong> ${record.village || 'N/A'}</p>
                        <p><strong>Species:</strong> ${record.species || 'N/A'}</p>
                        <p><strong>Seed Amount:</strong> ${record.seedAmountKg !== undefined ? `${record.seedAmountKg} kg` : 'N/A'}</p>
                        <p><strong>CPT No.:</strong> ${record.cptNo || 'N/A'}</p>
                        <p class="col-span-2 break-words">
                            <span class="font-bold">GPS:</span> ${record.gpsLocation || 'N/A'}
                        </p>
                    </div>
                    
                    <div class="flex space-x-2 mt-3 justify-end">
                        <button data-id="${docId}" data-action="delete" class="text-sm font-medium text-red-600 hover:text-red-800">Delete</button>
                    </div>
                `;
                dataList.appendChild(listItem);
            });

            dataList.querySelectorAll('button[data-action="delete"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.dataset.id;
                    showModal(
                        "Confirm Deletion",
                        "Are you sure you want to delete this record locally? This action will permanently remove the record and prevent it from being synced.",
                        [
                            { label: 'Cancel', className: 'bg-gray-200 text-gray-700 hover:bg-gray-300', onClick: closeModal },
                            { label: 'Delete', className: 'bg-red-600 text-white hover:bg-red-700', onClick: () => deleteLocalRecord(docId) }
                        ]
                    );
                });
            });
        }

        function saveData(e) {
            e.preventDefault();
            
            const record = {
                range: document.getElementById('input-range').value,
                village: document.getElementById('input-village').value.trim(),
                dateCollected: dateInput.value,
                species: document.getElementById('input-species').value,
                seedAmountKg: parseFloat(document.getElementById('input-seed-kg').value),
                gpsLocation: gpsInput.value.trim(),
                cptNo: document.getElementById('input-cpt').value.trim(),
                submittedAt: new Date().toISOString()
            };

            if (!record.gpsLocation || record.gpsLocation.includes('Unavailable') || record.gpsLocation.includes('Fetching') || !record.gpsLocation.startsWith('Lat:')) {
                 showModal("Input Error", "Please successfully fetch the GPS location before saving. Ensure you have a clear sky view for a satellite lock.", [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
                 return;
            }
            
            addLocalRecord(record);
            showModal("Local Save Success", "Record saved successfully to local storage. Click 'Sync' when you have a connection to upload it to Google Sheets.", [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
            
            form.reset(); 
            setTodayDate(); 
            gpsInput.value = 'Lat: -, Lon: -'; 
        }

        function deleteLocalRecord(docId) {
            let records = getLocalRecords().filter(r => r.id !== docId);
            
            saveLocalRecords(records); 
            showModal("Deleted", "Record removed from local device storage.", [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
        }
        
        // --- Google Apps Script Sync Logic (3-second delay implemented) ---

        async function syncToSheets() {
            if (APPS_SCRIPT_URL === "APPS_SCRIPT_URL_PLACEHOLDER") {
                showModal("Configuration Error", "The Google Apps Script URL has not been configured. Please replace the placeholder in the code.", [{label: 'OK', className: 'bg-red-600 text-white hover:bg-red-700', onClick: closeModal}]);
                return;
            }

            const pendingRecords = getPendingRecords();
            const recordCount = pendingRecords.length;
            if (recordCount === 0) {
                updateStatusIndicator();
                return;
            }

            if (!navigator.onLine) {
                 showModal("Network Error", "You must be online to initiate the synchronization process.", [{label: 'OK', className: 'bg-red-600 text-white hover:bg-red-700', onClick: closeModal}]);
                 return;
            }
            
            // 1. Show syncing modal
            updateStatusIndicator(true); 
            syncButton.disabled = true;
            saveButton.disabled = true;

            showModal("Syncing Data", `Attempting to upload ${recordCount} record(s) to Google Sheets. Please wait 3 seconds for confirmation...`, 
                      [{label: 'Working...', className: 'status-syncing text-yellow-800', autoClose: false}]
            );

            const payload = JSON.stringify({ records: pendingRecords });
            
            try {
                // 2. Fetch call (Fire and Forget - DO NOT AWAIT)
                fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: payload
                }).then(response => {
                    console.log("Fetch initiated successfully (response received/ignored).");
                }).catch(error => {
                    console.error("Non-critical Sync Error (ignored for user feedback):", error);
                });


                // 3. Immediately show Sync Done modal and clear local data AFTER a delay
                // Wait for 3 seconds as requested
                setTimeout(() => {
                    const syncedIds = pendingRecords.map(r => r.id);
                    markRecordsAsSynced(syncedIds); 
                    
                    isSyncDoneModalOpen = true; 
                    
                    closeModal(); 
                    showModal("Sync Complete!", 
                              `${recordCount} record(s) were successfully sent for logging. Local data has been cleared.`, 
                              [{label: 'OK (Clears Data)', className: 'status-success', onClick: () => {
                                  // The closeModal function handles renderData and updateStatusIndicator
                              }}]
                    );
                    
                    updateStatusIndicator(false); 

                }, 3000); // *** 3.0 second delay as requested ***

            } catch (error) {
                console.error("Immediate Sync failed (e.g., DNS/URL error):", error);
                closeModal();
                showModal("Sync Failed", 
                          `Failed to initiate sync connection. Please check your Apps Script URL. Error: ${error.message}`, 
                          [{label: 'Retry', className: 'primary-btn', onClick: () => syncToSheets()}, 
                           {label: 'Close', className: 'bg-gray-200 text-gray-700 hover:bg-gray-300', onClick: closeModal}]
                );
                syncButton.disabled = false;
                saveButton.disabled = false;
                updateStatusIndicator(false);
            }
        }
        
        // --- Download Logic (CSV and PDF) ---

        function downloadDataPrompt() {
            const records = getPendingRecords();
            if (records.length === 0) {
                showModal("No Data to Download", "There are no pending records in local storage to download.", [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
                return;
            }

            const recordCount = records.length;

            showModal(
                "Download Local Data",
                `Select the format to download your ${recordCount} pending record(s).`,
                [
                    { 
                        label: 'Download CSV', 
                        className: 'primary-btn bg-green-600 hover:bg-green-700', 
                        onClick: downloadAsCsv 
                    },
                    { 
                        label: 'Download PDF Report', 
                        className: 'primary-btn bg-indigo-600 hover:bg-indigo-700', 
                        onClick: downloadAsPDF 
                    }
                ]
            );
        }

        /**
         * Downloads the data as a CSV file.
         */
        function downloadAsCsv() {
            const records = getPendingRecords();
            if (records.length === 0) return;

            const fieldMap = {
                id: "Record ID",
                deviceId: "Device ID",
                dateCollected: "Date Collected",
                range: "Range",
                village: "Village",
                species: "Species",
                seedAmountKg: "Seed Amount (kg)",
                cptNo: "CPT No.",
                gpsLocation: "GPS Location",
                submittedAt: "Submitted At"
            };
            
            const keys = Object.keys(fieldMap);
            const headers = keys.map(key => fieldMap[key]);
            
            let csv = headers.join(',') + '\n';
            records.forEach(row => {
                const values = keys.map(key => {
                    let value = row[key] === null || row[key] === undefined ? '' : row[key];
                    value = String(value).replace(/"/g, '""'); 
                    if (value.includes(',') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csv += values.join(',') + '\n';
            });

            const dateStr = new Date().toISOString().split('T')[0];
            downloadFile(`seed_collection_pending_data_${dateStr}.csv`, csv, 'text/csv');
        }

        /**
         * Generates and downloads a true PDF file using html2canvas and jsPDF.
         */
        function downloadAsPDF() {
            const records = getPendingRecords();
            if (records.length === 0) return;
            
            showModal("Generating PDF", "Please wait while the PDF report is being created...", 
                     [{label: 'Processing...', className: 'status-syncing text-yellow-800', autoClose: false}]);

            const dateStr = new Date().toLocaleString();
            
            // 1. Generate HTML content for the PDF in the hidden wrapper
            let htmlContent = `<div style="padding: 20px; font-family: sans-serif; color: #1f2937;">`;
            htmlContent += `
                <div class="pdf-header">
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Seed Collection Pending Data Report</h1>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Generated: ${dateStr}</p>
                    <p style="font-size: 12px; color: #6b7280;">Device ID: ${deviceId}</p>
                    <p style="font-size: 14px; font-weight: 600; margin-top: 10px;">Total Records: ${records.length}</p>
                </div>
            `;
            
            records.forEach((record, index) => {
                const submittedDate = new Date(record.submittedAt).toLocaleString();
                htmlContent += `
                    <div class="pdf-record" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px;">
                        <h3 style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Record #${index + 1}</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                            <p><strong>Record ID:</strong> ${record.id}</p>
                            <p><strong>Date Collected:</strong> ${record.dateCollected}</p>
                            <p><strong>Range:</strong> ${record.range}</p>
                            <p><strong>Village:</strong> ${record.village}</p>
                            <p><strong>Species:</strong> ${record.species}</p>
                            <p><strong>Seed Amount (kg):</strong> ${record.seedAmountKg}</p>
                            <p><strong>CPT No.:</strong> ${record.cptNo}</p>
                            <p style="grid-column: span 2; word-wrap: break-word;"><strong>GPS Location:</strong> ${record.gpsLocation}</p>
                            <p style="grid-column: span 2;"><strong>Submitted At:</strong> ${submittedDate}</p>
                        </div>
                    </div>
                `;
            });

            htmlContent += `</div>`;
            pdfContentWrapper.innerHTML = htmlContent;

            // 2. Use html2canvas to render the hidden content as a canvas/image
            html2canvas(pdfContentWrapper, {
                scale: 2, // Increase scale for better resolution
                useCORS: true,
                logging: false,
                width: 1000, // Match wrapper width
            }).then(canvas => {
                // 3. Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                // 4. Add the image, creating new pages if content exceeds one page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // 5. Trigger download
                const fileName = `seed_collection_report_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);
                
                // 6. Cleanup and notify user
                pdfContentWrapper.innerHTML = '';
                closeModal(); // Close the processing modal
                showModal("PDF Download Complete", `The file '${fileName}' has been generated and downloaded.`, [{label: 'OK', className: 'primary-btn', onClick: closeModal}]);
            }).catch(error => {
                console.error("PDF Generation Error:", error);
                closeModal();
                showModal("PDF Generation Failed", `An error occurred while creating the PDF. Check console for details.`, [{label: 'Close', className: 'bg-red-600 hover:bg-red-700', onClick: closeModal}]);
            });
        }
        
        /**
         * Generic file download utility.
         */
        function downloadFile(filename, text, mimeType) {
            const element = document.createElement('a');
            element.setAttribute('href', `data:${mimeType};charset=utf-8,${encodeURIComponent(text)}`);
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }
        
        // --- Initialization ---

        function initializeApp() {
            setTodayDate();
            renderData();
            updateStatusIndicator(); 
            
            // Event Listeners
            form.addEventListener('submit', saveData);
            getGpsBtn.addEventListener('click', getGpsLocation);
            syncButton.addEventListener('click', syncToSheets);
            downloadButton.addEventListener('click', downloadDataPrompt); 
            
            // Check for connection status changes and update UI immediately
            window.addEventListener('online', () => updateStatusIndicator());
            window.addEventListener('offline', () => updateStatusIndicator());
        }
        
        // Start the application setup
        initializeApp();

    </script>
    <script>
      if ('serviceWorker' in navigator) {
        // Register the Service Worker with the specific repository scope
        const scope = '/seed-collection/'; 

        navigator.serviceWorker.register(`${scope}sw.js`, { scope: scope })
          .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(error => {
            console.error('Service Worker registration failed:', error);
          });
      }
    </script>
</body>
</html>
